---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SEOHead from '../components/SEOHead.astro';
import { getData } from '../lib/data';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: string;
  schema?: object;
}

const { title, description, image, type, schema } = Astro.props;
const theme = await getData('theme');

function hexToRgb(hex: string) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return { r, g, b };
}

function lighten(hex: string, amount: number) {
  const { r, g, b } = hexToRgb(hex);
  const lr = Math.min(255, r + Math.round((255 - r) * amount));
  const lg = Math.min(255, g + Math.round((255 - g) * amount));
  const lb = Math.min(255, b + Math.round((255 - b) * amount));
  return `#${lr.toString(16).padStart(2,'0')}${lg.toString(16).padStart(2,'0')}${lb.toString(16).padStart(2,'0')}`;
}

const brand = theme.brandColor || '#1B3A2D';
const accent = theme.accentColor || '#8B6D3F';
const brandLight = lighten(brand, 0.2);
const { r: br, g: bg2, b: bb } = hexToRgb(brand);
const { r: ar, g: ag, b: ab } = hexToRgb(accent);
const defaultMode = theme.mode || 'light';
const allowToggle = theme.allowVisitorToggle ?? false;
const fontFamily = theme.fontFamily || 'Inter';

const fontUrl = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(/ /g, '+')}:wght@300;400;500;600;700;800&display=swap`;
---

<!doctype html>
<html lang="en">
  <head>
    <SEOHead title={title} description={description} image={image} type={type} schema={schema} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href={fontUrl} rel="stylesheet" />
    <style define:vars={{
      brandColor: brand,
      brandLightColor: brandLight,
      brandR: br, brandG: bg2, brandB: bb,
      accentColor: accent,
      accentR: ar, accentG: ag, accentB: ab,
      fontFam: `'${fontFamily}', system-ui, -apple-system, sans-serif`,
      radius: theme.borderRadius || '0.5rem',
    }}>
      :root {
        --color-brand: var(--brandColor);
        --color-brand-light: var(--brandLightColor);
        --color-brand-muted: rgba(var(--brandR), var(--brandG), var(--brandB), 0.06);
        --color-brass: var(--accentColor);
        --color-brass-light: var(--accentColor);
        --color-brass-bg: rgba(var(--accentR), var(--accentG), var(--accentB), 0.08);
        --font-sans: var(--fontFam);
      }
      .dark {
        --color-brand: var(--brandLightColor);
        --color-brand-light: var(--brandColor);
        --color-brand-muted: rgba(var(--brandR), var(--brandG), var(--brandB), 0.15);
        --color-brass-bg: rgba(var(--accentR), var(--accentG), var(--accentB), 0.15);
      }
    </style>
    <script is:inline define:vars={{ defaultMode, allowToggle }}>
      (function() {
        if (!allowToggle) {
          if (defaultMode === 'dark') document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
          return;
        }
        var t = localStorage.getItem('theme');
        if (t === 'dark' || (!t && defaultMode === 'dark')) {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>
  </head>
  <body class="bg-bg text-body min-h-screen antialiased" style={`font-family: '${fontFamily}', system-ui, -apple-system, sans-serif;`}>
    <Header />
    <main class="pt-[60px]">
      <slot />
    </main>
    <Footer />
  </body>
</html>
